<script src="../shared-header.js"></script>
<!-- Meal Planner Component for Academic Allies -->
<!-- Place this file in components/meal-planner/meal-planner.html -->

<!-- Load pdf.js from CDN for PDF parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<section id="meal-planner" class="meal-planner" aria-label="Meal Planner and Suggestion Tool">
  <h2>Meal Planner</h2>
  <div class="meal-upload">
    <label for="base-meal-file" class="upload-label">Upload Base Meal Plan:</label>
    <input type="file" id="base-meal-file" accept=".json,.txt,.csv,.pdf" aria-label="Upload base meal plan" />
    <button type="button" id="load-base-meal" class="upload-btn">Load Base Plan</button>
  </div>
  <p class="file-types">File types accepted: .json, .txt, .csv, .pdf</p>
  <div class="meal-summary" aria-live="polite">
    <span id="meals-today">Meals Planned Today: <strong>0</strong></span>
    <button type="button" id="reset-meals" class="reset-btn" aria-label="Reset daily meals">Reset</button>
    <button type="button" id="suggest-meals" class="suggest-btn" aria-label="Generate meal suggestions">Suggest Meals</button>
  </div>
  <form id="add-meal-form" class="add-meal-form" autocomplete="off">
    <label for="meal-name">Meal</label>
    <input type="text" id="meal-name" name="meal-name" required aria-required="true" maxlength="40" />
    <label for="meal-time">Time</label>
    <input type="time" id="meal-time" name="meal-time" required aria-required="true" />
    <label for="meal-notes">Notes</label>
    <input type="text" id="meal-notes" name="meal-notes" maxlength="80" />
    <button type="submit" class="add-btn">Add Meal</button>
  </form>
  <div id="suggestion-list" class="suggestion-list" aria-label="Meal Suggestions">
    <!-- Suggestions will be dynamically added here -->
  </div>
  <ul id="meal-list" class="meal-list" aria-label="Planned Meals">
    <!-- Meals will be dynamically added here -->
  </ul>
</section>

<style>
.meal-planner {
  background: #f8fafc;
  border-radius: 1rem;
  padding: 1.5rem;
  max-width: 600px;
  margin: 2rem auto;
  box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}
.meal-planner h2 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
  color: #22223b;
}
.meal-upload {
  display: flex;
  align-items: center;
  gap: 1em;
  margin-bottom: 0.5em;
}
.upload-label {
  font-weight: 600;
}
.upload-btn {
  background: #3b82f6;
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.4em 1.2em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.2s;
}
.upload-btn:hover {
  background: #2563eb;
}
.file-types {
  font-size: 0.9em;
  color: #555;
  margin-bottom: 1em;
}
.meal-summary {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  font-size: 1.1em;
  gap: 1em;
}
.reset-btn {
  background: #ef4444;
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.4em 1em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.2s;
}
.reset-btn:hover {
  background: #dc2626;
}
.suggest-btn {
  background: #22c55e;
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.4em 1em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.2s;
}
.suggest-btn:hover {
  background: #16a34a;
}
.add-meal-form {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5em 1em;
  align-items: flex-end;
  margin-bottom: 1rem;
}
.add-meal-form label {
  flex: 1 1 100px;
  font-weight: 600;
}
.add-meal-form input {
  flex: 2 1 120px;
  padding: 0.3em;
  border-radius: 0.3em;
  border: 1px solid #bdbdbd;
}
.add-btn {
  background: #22c55e;
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.5em 1.2em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.2s;
}
.add-btn:hover {
  background: #16a34a;
}
.meal-list, .suggestion-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.meal-item, .suggestion-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  border-radius: 0.5em;
  padding: 0.7em 1em;
  margin-bottom: 0.5em;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03);
}
.meal-info, .suggestion-info {
  display: flex;
  flex-direction: column;
}
.meal-name, .suggestion-name {
  font-weight: 600;
  color: #22223b;
}
.meal-time, .suggestion-time {
  color: #3b82f6;
  font-size: 0.95em;
}
.meal-notes, .suggestion-notes {
  color: #555;
  font-size: 0.95em;
}
.remove-btn, .add-suggestion-btn {
  background: #bdbdbd;
  color: #22223b;
  border: none;
  border-radius: 0.5em;
  padding: 0.3em 0.9em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.2s;
}
.remove-btn:hover, .add-suggestion-btn:hover {
  background: #a3a3a3;
}
.remove-btn:focus, .add-suggestion-btn:focus {
  outline: 2px solid #ef4444;
}
@media (max-width: 700px) {
  .meal-planner {
    padding: 1em;
  }
  .add-meal-form {
    flex-direction: column;
    gap: 0.5em 0;
  }
  .meal-summary {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5em;
  }
}
</style>

<script>
// Meal Planner Component Logic

let meals = [];
let baseMeals = [];
let dietaryRules = { allowed: [], restricted: [], portionLimits: [], timingRules: [] };

function updateMealsDisplay() {
  const mealsElem = document.getElementById('meals-today');
  mealsElem.innerHTML = `Meals Planned Today: <strong>${meals.length}</strong>`;
}

function renderMeals() {
  const list = document.getElementById('meal-list');
  list.innerHTML = '';
  meals.forEach((meal, idx) => {
    const li = document.createElement('li');
    li.className = 'meal-item';
    li.setAttribute('data-idx', idx);

    const info = document.createElement('div');
    info.className = 'meal-info';
    const name = document.createElement('span');
    name.className = 'meal-name';
    name.textContent = meal.name;
    info.appendChild(name);

    const time = document.createElement('span');
    time.className = 'meal-time';
    time.textContent = `Time: ${meal.time}`;
    info.appendChild(time);

    if (meal.notes) {
      const notes = document.createElement('span');
      notes.className = 'meal-notes';
      notes.textContent = `Notes: ${meal.notes}`;
      info.appendChild(notes);
    }

    li.appendChild(info);

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.type = 'button';
    removeBtn.setAttribute('aria-label', `Remove meal ${meal.name}`);
    removeBtn.textContent = 'Remove';
    removeBtn.addEventListener('click', () => {
      meals.splice(idx, 1);
      saveMeals();
      renderMeals();
      updateMealsDisplay();
    });
    li.appendChild(removeBtn);

    list.appendChild(li);
  });
}

function renderSuggestions(suggestions) {
  const list = document.getElementById('suggestion-list');
  list.innerHTML = '';
  suggestions.forEach(meal => {
    const div = document.createElement('div');
    div.className = 'suggestion-item';

    const info = document.createElement('div');
    info.className = 'suggestion-info';
    const name = document.createElement('span');
    name.className = 'suggestion-name';
    name.textContent = meal.name;
    info.appendChild(name);

    const time = document.createElement('span');
    time.className = 'suggestion-time';
    time.textContent = `Time: ${meal.time}`;
    info.appendChild(time);

    if (meal.notes) {
      const notes = document.createElement('span');
      notes.className = 'suggestion-notes';
      notes.textContent = `Notes: ${meal.notes}`;
      info.appendChild(notes);
    }

    div.appendChild(info);

    const addBtn = document.createElement('button');
    addBtn.className = 'add-suggestion-btn';
    addBtn.type = 'button';
    addBtn.setAttribute('aria-label', `Add suggested meal ${meal.name} to plan`);
    addBtn.textContent = 'Add to Plan';
    addBtn.addEventListener('click', () => {
      meals.push({ ...meal });
      saveMeals();
      renderMeals();
      updateMealsDisplay();
    });
    div.appendChild(addBtn);

    list.appendChild(div);
  });
}

function generateSuggestions() {
  if (baseMeals.length === 0) {
    alert('Please upload a base meal plan first.');
    return;
  }
  // Generate up to 3 meal suggestions based on meal times and dietary rules
  const suggestions = [];
  const mealTimes = [...new Set(baseMeals.map(meal => meal.time))]; // Unique times
  const shuffledTimes = mealTimes.sort(() => Math.random() - 0.5).slice(0, Math.min(3, mealTimes.length));

  shuffledTimes.forEach(time => {
    // Get allowed foods for this time
    const allowedFoods = baseMeals
      .filter(meal => meal.time === time)
      .flatMap(meal => meal.allowedFoods || []);
    if (allowedFoods.length === 0) return;

    // Pick a random allowed food or combination
    const selectedFood = allowedFoods[Math.floor(Math.random() * allowedFoods.length)];
    const name = selectedFood;
    let notes = '';

    // Apply portion limits and restrictions
    const portionLimit = dietaryRules.portionLimits.find(rule => rule.food === selectedFood);
    if (portionLimit) notes += `Small portion of ${selectedFood}. `;
    const restrictions = dietaryRules.restricted.filter(food => !selectedFood.includes(food));
    if (restrictions.length > 0) notes += `No ${restrictions.join(', ')}.`;

    // Check timing rules (e.g., liquids after 5pm)
    const currentHour = parseInt(time.split(':')[0]);
    if (dietaryRules.timingRules.some(rule => rule.type === 'liquids' && currentHour >= 17)) {
      notes += ' Liquids only (e.g., water, herbal tea).';
    }

    suggestions.push({ name, time, notes: notes.trim() });
  });

  renderSuggestions(suggestions);
}

function saveMeals() {
  localStorage.setItem('plannedMeals', JSON.stringify(meals));
}

function loadMeals() {
  const saved = localStorage.getItem('plannedMeals');
  if (saved) {
    try {
      meals = JSON.parse(saved);
    } catch {
      meals = [];
    }
  }
}

function saveBaseMeals() {
  localStorage.setItem('baseMeals', JSON.stringify(baseMeals));
  localStorage.setItem('dietaryRules', JSON.stringify(dietaryRules));
}

function loadBaseMeals() {
  const savedMeals = localStorage.getItem('baseMeals');
  const savedRules = localStorage.getItem('dietaryRules');
  if (savedMeals) {
    try {
      baseMeals = JSON.parse(savedMeals);
    } catch {
      baseMeals = [];
    }
  }
  if (savedRules) {
    try {
      dietaryRules = JSON.parse(savedRules);
    } catch {
      dietaryRules = { allowed: [], restricted: [], portionLimits: [], timingRules: [] };
    }
  }
}

function resetMeals() {
  meals = [];
  saveMeals();
  renderMeals();
  updateMealsDisplay();
}

async function parseBaseMealFile(file, callback) {
  const extension = file.name.split('.').pop().toLowerCase();
  let textContent = '';

  try {
    if (extension === 'pdf') {
      // Initialize pdf.js
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
      const reader = new FileReader();
      reader.onload = async function (e) {
        const typedArray = new Uint8Array(e.target.result);
        const pdf = await pdfjsLib.getDocument(typedArray).promise;
        let text = '';
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const content = await page.getTextContent();
          text += content.items.map(item => item.str).join(' ') + '\n';
        }
        textContent = text;
      };
      reader.readAsArrayBuffer(file);
      await new Promise(resolve => {
        reader.onloadend = resolve;
      });
    } else {
      const reader = new FileReader();
      reader.onload = function (e) {
        textContent = e.target.result;
      };
      reader.readAsText(file);
      await new Promise(resolve => {
        reader.onloadend = resolve;
      });
    }

    let parsedMeals = [];
    dietaryRules = { allowed: [], restricted: [], portionLimits: [], timingRules: [] };

    if (extension === 'json') {
      const data = JSON.parse(textContent);
      if (!Array.isArray(data)) throw new Error('Invalid JSON format');
      parsedMeals = data;
      // Extract dietary rules if present in JSON
      if (data.dietaryRules) {
        dietaryRules = data.dietaryRules;
      }
    } else if (extension === 'csv' || extension === 'txt') {
      const lines = textContent.split('\n').filter(Boolean);
      parsedMeals = lines.map(line => {
        const [name, time, notes] = line.split(',').map(item => item?.trim() || '');
        return { name, time, notes };
      });
    } else if (extension === 'pdf') {
      // Parse free text PDF for dietary rules and meal times
      const lines = textContent.split('\n').filter(Boolean);
      lines.forEach(line => {
        // Meal time and allowed foods (e.g., "Breakfast at 8:00 AM: Oatmeal, eggs")
        const mealMatch = line.match(/(\w+)\s*(?:at|@)\s*(\d{1,2}:\d{2}\s*(?:AM|PM)?)\s*:\s*([^.]+)/i);
        if (mealMatch) {
          let [, mealName, time, foods] = mealMatch;
          const allowedFoods = foods.split(',').map(f => f.trim()).filter(Boolean);
          // Normalize time to 24-hour format
          time = time.replace(/\s*AM/i, '').replace(/\s*PM/i, (match, offset) => {
            const [hours] = time.split(':');
            return parseInt(hours) < 12 ? `:${parseInt(hours) + 12}` : match;
          });
          time = time.padStart(5, '0');
          parsedMeals.push({ name: mealName, time, allowedFoods });
        }
        // Restricted foods (e.g., "Can’t eat dairy, gluten")
        const restrictedMatch = line.match(/(?:can’t|cannot|no)\s+eat\s+([^.]+)/i);
        if (restrictedMatch) {
          const restrictedFoods = restrictedMatch[1].split(',').map(f => f.trim()).filter(Boolean);
          dietaryRules.restricted.push(...restrictedFoods);
        }
        // Allowed foods (e.g., "Can eat chicken, rice")
        const allowedMatch = line.match(/can\s+eat\s+([^.]+)/i);
        if (allowedMatch) {
          const allowedFoods = allowedMatch[1].split(',').map(f => f.trim()).filter(Boolean);
          dietaryRules.allowed.push(...allowedFoods);
        }
        // Portion limits (e.g., "Only a little sugar")
        const portionMatch = line.match(/only\s+a\s+little\s+([^.]+)/i);
        if (portionMatch) {
          dietaryRules.portionLimits.push({ food: portionMatch[1].trim(), rule: 'small portion' });
        }
        // Timing rules (e.g., "Liquids after 5:00 PM")
        const timingMatch = line.match(/liquids\s+after\s+(\d{1,2}:\d{2}\s*(?:AM|PM)?)/i);
        if (timingMatch) {
          let time = timingMatch[1];
          time = time.replace(/\s*AM/i, '').replace(/\s*PM/i, (match, offset) => {
            const [hours] = time.split(':');
            return parseInt(hours) < 12 ? `:${parseInt(hours) + 12}` : match;
          });
          time = time.padStart(5, '0');
          dietaryRules.timingRules.push({ type: 'liquids', time });
        }
      });
    } else {
      throw new Error('Unsupported file type');
    }
    // Validate meal objects
    parsedMeals = parsedMeals.filter(meal => meal.name && meal.time);
    if (parsedMeals.length === 0 && dietaryRules.allowed.length === 0) {
      throw new Error}
.add-meal-form input {
  flex: 2 1 120px;
  padding: 0.3em;
  border-radius: 0.3em;
  border: 1px solid #bdbdbd;
}
.add-btn {
  background: #22c55e;
  color: #fff;
  border: none;
  border-radius: 0.5em;
  padding: 0.5em 1.2em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.2s;
}
.meal-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.meal-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  border-radius: 0.5em;
  padding: 0.7em 1em;
  margin-bottom: 0.5em;
  box-shadow: 0 1px 3px rgba(0,0,0,0.03);
}
.meal-info {
  display: flex;
  flex-direction: column;
}
.meal-name {
  font-weight: 600;
  color: #22223b;
}
.meal-time {
  color: #3b82f6;
  font-size: 0.95em;
}
.meal-notes {
  color: #555;
  font-size: 0.95em;
}
.remove-btn {
  background: #bdbdbd;
  color: #22223b;
  border: none;
  border-radius: 0.5em;
  padding: 0.3em 0.9em;
  font-size: 1em;
  cursor: pointer;
  transition: background 0.2s;
}
.remove-btn:focus {
  outline: 2px solid #ef4444;
}
@media (max-width: 700px) {
  .meal-planner {
    padding: 1em;
  }
  .add-meal-form {
    flex-direction: column;
    gap: 0.5em 0;
  }
}
</style>

<script>
// Meal Planner Component Logic

let meals = [];

function updateMealsDisplay() {
  const mealsElem = document.getElementById('meals-today');
  mealsElem.innerHTML = `Meals Planned Today: <strong>${meals.length}</strong>`;
}

function renderMeals() {
  const list = document.getElementById('meal-list');
  list.innerHTML = '';
  meals.forEach((meal, idx) => {
    const li = document.createElement('li');
    li.className = 'meal-item';
    li.setAttribute('data-idx', idx);

    const info = document.createElement('div');
    info.className = 'meal-info';
    const name = document.createElement('span');
    name.className = 'meal-name';
    name.textContent = meal.name;
    info.appendChild(name);

    const time = document.createElement('span');
    time.className = 'meal-time';
    time.textContent = `Time: ${meal.time}`;
    info.appendChild(time);

    if (meal.notes) {
      const notes = document.createElement('span');
      notes.className = 'meal-notes';
      notes.textContent = `Notes: ${meal.notes}`;
      info.appendChild(notes);
    }

    li.appendChild(info);

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.type = 'button';
    removeBtn.setAttribute('aria-label', `Remove meal ${meal.name}`);
    removeBtn.textContent = 'Remove';
    removeBtn.addEventListener('click', () => {
      meals.splice(idx, 1);
      saveMeals();
      renderMeals();
      updateMealsDisplay();
    });
    li.appendChild(removeBtn);

    list.appendChild(li);
  });
}

function saveMeals() {
  localStorage.setItem('plannedMeals', JSON.stringify(meals));
}

function loadMeals() {
  const saved = localStorage.getItem('plannedMeals');
  if (saved) {
    try {
      meals = JSON.parse(saved);
    } catch {
      meals = [];
    }
  }
}

function resetMeals() {
  meals = [];
  saveMeals();
  renderMeals();
  updateMealsDisplay();
}

function parseBaseMealFile(file, callback) {
  const extension = file.name.split('.').pop().toLowerCase();
  const reader = new FileReader();

  reader.onload = function (e) {
    let baseMeals = [];
    try {
      if (extension === 'json') {
        baseMeals = JSON.parse(e.target.result);
        if (!Array.isArray(baseMeals)) throw new Error('Invalid JSON format');
      } else if (extension === 'csv' || extension === 'txt') {
        const lines = e.target.result.split('\n').filter(Boolean);
        baseMeals = lines.map(line => {
          const [name, time, notes] = line.split(',').map(item => item?.trim() || '');
          return { name, time, notes };
        });
      } else if (extension === 'pdf' || extension === 'doc' || extension === 'docx') {
        // Simplified handling: assume text-based content in a similar format
        // Note: Real PDF/DOC parsing requires external libraries (e.g., pdf.js, mammoth.js)
        const text = e.target.result;
        const lines = text.split('\n').filter(Boolean);
        baseMeals = lines.map(line => {
          const [name, time, notes] = line.split(',').map(item => item?.trim() || '');
          return { name, time, notes };
        });
        console.warn(`Parsing .${extension} files is limited. For full support, integrate a parsing library.`);
      } else {
        throw new Error('Unsupported file type');
      }
    } catch (err) {
      alert(`Error parsing file: ${err.message}. Please ensure the file is correctly formatted.`);
      return;
    }
    // Validate meal objects
    baseMeals = baseMeals.filter(meal => meal.name && meal.time);
    callback(baseMeals);
  };

  // Read as text for simplicity; PDFs and DOCs may need binary handling with libraries
  reader.readAsText(file);
}

document.addEventListener('DOMContentLoaded', function () {
  loadMeals();
  renderMeals();
  updateMealsDisplay();

  document.getElementById('add-meal-form').addEventListener('submit', function (e) {
    e.preventDefault();
    const name = document.getElementById('meal-name').value.trim();
    const time = document.getElementById('meal-time').value;
    const notes = document.getElementById('meal-notes').value.trim();
    if (!name || !time) return;

    meals.push({ name, time, notes });
    saveMeals();
    renderMeals();
    updateMealsDisplay();
    this.reset();
  });

  document.getElementById('reset-meals').addEventListener('click', function () {
    if (confirm('Reset all planned meals for today?')) {
      resetMeals();
    }
  });

  document.getElementById('load-base-meal').addEventListener('click', function () {
    const fileInput = document.getElementById('base-meal-file');
    const file = fileInput.files[0];
    if (!file) {
      alert('Please select a base meal plan file to upload.');
      return;
    }
    parseBaseMealFile(file, function (baseMeals) {
      meals = baseMeals;
      saveMeals();
      renderMeals();
      updateMealsDisplay();
      alert('Base meal plan loaded and integrated!');
    });
  });
});
</script>
