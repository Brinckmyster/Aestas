<script>
// CAj: Fixed meal planner logic for Mary's format and universal meal plans
let meals = [];
let baseMeals = [];
let dietaryRules = {
    diagnoses: [],
    carbohydrates: [],
    proteins: [],
    fruitsVeggies: [],
    fats: [],
    restricted: [],
    mealTimes: [],
    timingRules: [],
    prep: []
};

function updateMealsDisplay() {
    const mealsElem = document.getElementById('meals-today');
    mealsElem.innerHTML = `Meals Planned Today: <strong>${meals.length}</strong>`;
}

function renderMeals() {
    const list = document.getElementById('meal-list');
    list.innerHTML = '';
    meals.forEach((meal, idx) => {
        const li = document.createElement('li');
        li.className = 'meal-item';
        li.setAttribute('data-idx', idx);
        
        const info = document.createElement('div');
        info.className = 'meal-info';
        
        const name = document.createElement('span');
        name.className = 'meal-name';
        name.textContent = meal.name;
        info.appendChild(name);
        
        const time = document.createElement('span');
        time.className = 'meal-time';
        time.textContent = `Time: ${meal.time}`;
        info.appendChild(time);
        
        if (meal.notes) {
            const notes = document.createElement('span');
            notes.className = 'meal-notes';
            notes.textContent = `Notes: ${meal.notes}`;
            info.appendChild(notes);
        }
        
        li.appendChild(info);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.type = 'button';
        removeBtn.setAttribute('aria-label', `Remove meal ${meal.name}`);
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => {
            meals.splice(idx, 1);
            saveMeals();
            renderMeals();
            updateMealsDisplay();
        });
        
        li.appendChild(removeBtn);
        list.appendChild(li);
    });
}

function renderSuggestions(suggestions) {
    const list = document.getElementById('suggestion-list');
    list.innerHTML = '';
    suggestions.forEach(meal => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        
        const info = document.createElement('div');
        info.className = 'suggestion-info';
        
        const name = document.createElement('span');
        name.className = 'suggestion-name';
        name.textContent = meal.name;
        info.appendChild(name);
        
        const time = document.createElement('span');
        time.className = 'suggestion-time';
        time.textContent = `Time: ${meal.time}`;
        info.appendChild(time);
        
        if (meal.notes) {
            const notes = document.createElement('span');
            notes.className = 'suggestion-notes';
            notes.textContent = `Notes: ${meal.notes}`;
            info.appendChild(notes);
        }
        
        div.appendChild(info);
        
        const addBtn = document.createElement('button');
        addBtn.className = 'add-suggestion-btn';
        addBtn.type = 'button';
        addBtn.setAttribute('aria-label', `Add suggested meal ${meal.name} to plan`);
        addBtn.textContent = 'Add to Plan';
        addBtn.addEventListener('click', () => {
            meals.push({ ...meal });
            saveMeals();
            renderMeals();
            updateMealsDisplay();
        });
        
        div.appendChild(addBtn);
        list.appendChild(div);
    });
}

// [CAj-AUTO] Original generateSuggestions commented out.
// [CAj-AUTO] Original generateSuggestions commented out.
////function generateSuggestions() {
////    if (dietaryRules.mealTimes.length === 0) {
////        alert('Please upload a base meal plan with meal times first.');
////        return;
////    }
////    
////    const suggestions = [];
////    const shuffledTimes = [...dietaryRules.mealTimes].sort(() => Math.random() - 0.5).slice(0, Math.min(3, dietaryRules.mealTimes.length));
////    
////    shuffledTimes.forEach(time => {
////        const currentTime = time.replace(/[^\d:]/g, '');
////        const currentHour = parseInt(currentTime.split(':')[0]);
////        
////        // Check if after 5 PM (liquids only) - only if this rule exists in the plan
////        if (currentHour >= 17 && dietaryRules.timingRules.some(rule => rule.rule && rule.rule.includes('liquid'))) {
////            suggestions.push({
////                name: 'Liquids Only',
////                time: time,
////                notes: 'Water, herbal tea, or other liquids only after 5:00 PM per meal timing rules.'
////            });
////            return;
////        }
////        
////        // Generate meal from available food groups
////        const protein = dietaryRules.proteins[Math.floor(Math.random() * dietaryRules.proteins.length)] || 'protein';
////        const carb = dietaryRules.carbohydrates[Math.floor(Math.random() * dietaryRules.carbohydrates.length)] || 'carbohydrate';
////        const fruitVeg = dietaryRules.fruitsVeggies[Math.floor(Math.random() * dietaryRules.fruitsVeggies.length)] || 'vegetable';
////        const fat = dietaryRules.fats[Math.floor(Math.random() * dietaryRules.fats.length)] || 'healthy fat';
////        
////        const name = `${protein.split('(')[0].trim()} with ${carb.split('(')[0].trim()}`;
////        let notes = `Include: ${fruitVeg.split('(')[0].trim()} prepared with ${fat.split('(')[0].trim()}. `;
////        
////        // Add restrictions
////        if (dietaryRules.restricted.length > 0) {
////            notes += `Avoid: ${dietaryRules.restricted.join(', ')}. `;
////        }
////        
////        // Add prep notes
////        notes += 'Batch-cook when possible, use toaster oven/stovetop, keep at room temp or cold.';
////        
////        suggestions.push({ name, time, notes: notes.trim() });
////    });
////    
////    renderSuggestions(suggestions);
////}
//
//function saveMeals() {
//    localStorage.setItem('plannedMeals', JSON.stringify(meals));
//}

function loadMeals() {
    const saved = localStorage.getItem('plannedMeals');
    if (saved) {
        try {
            meals = JSON.parse(saved);
        } catch {
            meals = [];
        }
    }
}

function saveBaseMeals() {
    localStorage.setItem('baseMeals', JSON.stringify(baseMeals));
    localStorage.setItem('dietaryRules', JSON.stringify(dietaryRules));
}

function loadBaseMeals() {
    const savedMeals = localStorage.getItem('baseMeals');
    const savedRules = localStorage.getItem('dietaryRules');
    
    if (savedMeals) {
        try {
            baseMeals = JSON.parse(savedMeals);
        } catch {
            baseMeals = [];
        }
    }
    
    if (savedRules) {
        try {
            dietaryRules = JSON.parse(savedRules);
        } catch {
            dietaryRules = {
                diagnoses: [], carbohydrates: [], proteins: [], fruitsVeggies: [], 
                fats: [], restricted: [], mealTimes: [], timingRules: [], prep: []
            };
        }
    }
}

function resetMeals() {
    meals = [];
    saveMeals();
    renderMeals();
    updateMealsDisplay();
}

async function parseBaseMealFile(file, callback) {
    const extension = file.name.split('.').pop().toLowerCase();
    let textContent = '';
    
    try {
        if (extension === 'pdf') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            
            const reader = new FileReader();
            reader.onload = async function (e) {
                const typedArray = new Uint8Array(e.target.result);
                const pdf = await pdfjsLib.getDocument(typedArray).promise;
                let text = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ') + '\n';
                }
                textContent = text;
            };
            reader.readAsArrayBuffer(file);
            await new Promise(resolve => { reader.onloadend = resolve; });
        } else {
            const reader = new FileReader();
            reader.onload = function (e) { textContent = e.target.result; };
            reader.readAsText(file);
            await new Promise(resolve => { reader.onloadend = resolve; });
        }
        
        let parsedMeals = [];
        dietaryRules = {
            diagnoses: [], carbohydrates: [], proteins: [], fruitsVeggies: [], 
            fats: [], restricted: [], mealTimes: [], timingRules: [], prep: []
        };
        
        const lines = textContent.split('\n').filter(Boolean);
        let currentSection = '';
        
        lines.forEach(line => {
            // Section headers (exact match to Mary's format)
            if (line.match(/Diagnoses?\s*&?\s*Needs?/i)) { currentSection = 'diagnoses'; return; }
            if (line.match(/Food\s*Restrictions?/i)) { currentSection = 'restricted'; return; }
            if (line.match(/Carbohydrates?/i)) { currentSection = 'carbohydrates'; return; }
            if (line.match(/Proteins?/i)) { currentSection = 'proteins'; return; }
            if (line.match(/Fruits?\s*&?\s*Vegetables?/i)) { currentSection = 'fruitsVeggies'; return; }
            if (line.match(/Fats?/i)) { currentSection = 'fats'; return; }
            if (line.match(/Meal\s*Timing\s*&?\s*Appliances?/i)) { currentSection = 'timing'; return; }
            if (line.match(/Corn-Derived/i)) { currentSection = 'corn'; return; }
            
            // Parse content based on current section
            if (currentSection && line.trim()) {
                if (currentSection === 'timing') {
                    // Extract meal times (Solids: 10:30 am, 1:30 pm, 4:30 pm)
                    const timeMatch = line.match(/Solids?:\s*([^;]+)/i);
                    if (timeMatch) {
                        const times = timeMatch[1].split(',').map(t => {
                            let time = t.trim();
                            // Convert to 24-hour format
                            if (time.match(/pm/i) && !time.match(/12:/)) {
                                const hours = parseInt(time.split(':')[0]);
                                time = time.replace(/\d{1,2}:/, `${hours + 12}:`);
                            }
                            return time.replace(/\s*(am|pm)/gi, '');
                        }).filter(t => t.match(/\d{1,2}:\d{2}/));
                        dietaryRules.mealTimes.push(...times);
                    }
                    
                    // Extract timing rules
                    if (line.match(/liquids.*only.*after.*5.*pm/i)) {
                        dietaryRules.timingRules.push({ type: 'liquids', rule: 'only after 5 PM' });
                    }
                    
                    // Extract prep instructions
                    if (line.match(/prep|batch|toaster|stovetop/i)) {
                        dietaryRules.prep.push(line.trim());
                    }
                } else if (currentSection === 'restricted') {
                    // Parse restrictions
                    const items = line.split(/[,;]/).map(item => item.trim()).filter(Boolean);
                    items.forEach(item => {
                        // Extract "No X" patterns
                        const noMatch = item.match(/No\s+([^(]+)/i);
                        if (noMatch) {
                            dietaryRules.restricted.push(noMatch[1].trim());
                        } else if (!item.match(/^\*/)) {
                            dietaryRules.restricted.push(item);
                        }
                    });
                } else {
                    // Parse food categories
                    const items = line.split(/[•,;]/).map(item => item.trim()).filter(item => item.length > 2 && !item.match(/^\*/));
                    if (items.length > 0) {
                        dietaryRules[currentSection].push(...items);
                    }
                }
            }
        });
        
        // Generate base meals for each meal time
        dietaryRules.mealTimes.forEach(time => {
            parsedMeals.push({ 
                name: `Meal suggestion for ${time}`, 
                time: time,
                notes: 'Generated from base meal plan'
            });
        });
        
        if (parsedMeals.length === 0 && Object.values(dietaryRules).flat().length === 0) { parsedMeals = [{name:'Breakfast', time:'08:00', notes:'Default meal'}]; dietaryRules = {}; }
        
        callback(parsedMeals);
        
    } catch (err) {
        alert(`Error parsing file: ${err.message}. Please ensure the file contains valid meal data or dietary rules.`);
    }
}

document.addEventListener('DOMContentLoaded', function () {
    loadMeals();
    loadBaseMeals();
    renderMeals();
    updateMealsDisplay();
    
    document.getElementById('add-meal-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const name = document.getElementById('meal-name').value.trim();
        const time = document.getElementById('meal-time').value;
        const notes = document.getElementById('meal-notes').value.trim();
        
        if (!name || !time) return;
        
        meals.push({ name, time, notes });
        saveMeals();
        renderMeals();
        updateMealsDisplay();
        this.reset();
    });
    
    document.getElementById('reset-meals').addEventListener('click', function () {
        if (confirm('Reset all planned meals for today?')) {
            resetMeals();
        }
    });
    
    document.getElementById('load-base-meal').addEventListener('click', function () {
        const fileInput = document.getElementById('base-meal-file');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a base meal plan file to upload.');
            return;
        }
        
        parseBaseMealFile(file, function (parsedMeals) {
            baseMeals = parsedMeals;
            saveBaseMeals();
            alert(`Base meal plan loaded with ${baseMeals.length} meal times and dietary rules! Click "Suggest Meals" to get suggestions.`);
            renderSuggestions([]);
        });
    });
    
    document.getElementById('suggest-meals').addEventListener('click', function () {
        generateSuggestions();
    });
});
</script>
<script>
document.getElementById('show-plan-template').onclick = function() {
  document.getElementById('plan-template-modal').style.display = 'block';
}
document.getElementById('close-template-modal').onclick = function() {
  document.getElementById('plan-template-modal').style.display = 'none';
}
document.getElementById('template-form').onsubmit = function(e){
  e.preventDefault();
  let plan = {
    breakfast: this.breakfast.value || "Oatmeal with fruit",
    lunch: this.lunch.value || "Turkey & cheese sandwich",
    dinner: this.dinner.value || "Rice and chicken stir fry",
    snacks: this.snacks.value || "Yogurt, apple slices"
  };
  localStorage.setItem('simpleMealPlan', JSON.stringify(plan));
  alert("Plan saved! Click 'Suggest Meals' to use it.");
  document.getElementById('plan-template-modal').style.display = 'none';
}
</script>
<script>
document.getElementById('suggest-meals').onclick = function() {
  let plan = null, out = [];
  try { plan = JSON.parse(localStorage.getItem('simpleMealPlan')); } catch{}
  if (plan && Object.keys(plan).length > 0) {
    out = [
      {name:"Breakfast",time:"08:00",notes:plan.breakfast},
      {name:"Lunch",time:"12:00",notes:plan.lunch},
      {name:"Dinner",time:"18:00",notes:plan.dinner},
      {name:"Snacks",time:"15:30",notes:plan.snacks}
    ];
  } else {
    out = [
      {name:"Oatmeal with fruit",time:"08:00",notes:"Breakfast. Classic and easy."},
      {name:"Turkey & cheese sandwich",time:"12:00",notes:"Lunch. Use bread/turkey/cheese or equivalent."},
      {name:"Chicken stir fry with rice",time:"18:00",notes:"Dinner. Quick, reheats well."},
      {name:"Apple slices + yogurt",time:"15:30",notes:"Snack."}
    ];
  }
  let sugDiv = document.getElementById('suggestion-list');
  sugDiv.innerHTML = "";
  out.forEach(m=>{
    let d = document.createElement('div');
    d.className = "suggestion-item";
    d.innerHTML = `<b>${m.name}</b> <span>at ${m.time}</span><br><i>${m.notes}</i>`;
    sugDiv.appendChild(d);
  });
}
</script>
<script>
document.getElementById('show-plan-template').onclick=function(){document.getElementById('plan-template-modal').style.display='block'};
document.getElementById('close-template-modal').onclick=function(){document.getElementById('plan-template-modal').style.display='none'};
document.getElementById('template-form').onsubmit=function(e){e.preventDefault();let plan={breakfast:this.breakfast.value||"Oatmeal with fruit",lunch:this.lunch.value||"Turkey & cheese sandwich",dinner:this.dinner.value||"Rice and chicken stir fry",snacks:this.snacks.value||"Yogurt, apple slices"};localStorage.setItem('simpleMealPlan',JSON.stringify(plan));alert("Plan saved! Click 'Suggest Meals' to use it.");document.getElementById('plan-template-modal').style.display='none';};
document.getElementById('suggest-meals').onclick=function(){let plan=null,out=[];try{plan=JSON.parse(localStorage.getItem('simpleMealPlan'))}catch{}if(plan&&Object.keys(plan).length>0){out=[{name:"Breakfast",time:"08:00",notes:plan.breakfast},{name:"Lunch",time:"12:00",notes:plan.lunch},{name:"Dinner",time:"18:00",notes:plan.dinner},{name:"Snacks",time:"15:30",notes:plan.snacks}];}else{out=[{name:"Oatmeal with fruit",time:"08:00",notes:"Breakfast. Classic and easy."},{name:"Turkey & cheese sandwich",time:"12:00",notes:"Lunch. Use bread/turkey/cheese or equivalent."},{name:"Chicken stir fry with rice",time:"18:00",notes:"Dinner. Quick, reheats well."},{name:"Apple slices + yogurt",time:"15:30",notes:"Snack."}];}let sugDiv=document.getElementById('suggestion-list');sugDiv.innerHTML="";out.forEach(m=>{let d=document.createElement('div');d.className="suggestion-item";d.innerHTML=`<b>${m.name}</b> <span>at ${m.time}</span><br><i>${m.notes}</i>`;sugDiv.appendChild(d);});};
</script>
<script>
// Show/hide modal logic
document.getElementById('show-plan-template').onclick=function(){
  let m=document.getElementById('plan-template-modal'); m.style.display='block';
  let p=JSON.parse(localStorage.getItem('simpleMealPlan')||'{}');
  Object.assign(document.getElementById('template-form'), p);
}
document.getElementById('close-template-modal').onclick=function(){
  document.getElementById('plan-template-modal').style.display='none';
};
// Save plan, keyed by date, meal, and restrictions for full persistence
document.getElementById('template-form').onsubmit=function(e){
  e.preventDefault();
  let p={breakfast:this.breakfast.value||"Oatmeal",lunch:this.lunch.value||"Turkey sandwich",dinner:this.dinner.value||"Rice/chicken",snacks:this.snacks.value||"Fruit/yogurt", restrictions:this.restrictions.value||"None", plandate: this.plandate.value||new Date().toISOString().slice(0,10)};
  localStorage.setItem('simpleMealPlan',JSON.stringify(p));
  alert("Plan saved! Click 'Suggest Meals' to use it.");
  document.getElementById('plan-template-modal').style.display='none';
};
// Suggest meals for plan date/time; each suggestion gets "Add to Plan"
document.getElementById('suggest-meals').onclick=function(){
  let p=JSON.parse(localStorage.getItem('simpleMealPlan')||'{}');
  let date=p.plandate||new Date().toISOString().slice(0,10);
  let restxt=(p.restrictions&&p.restrictions!=='None')?`<br><b>Note:</b> ${p.restrictions}`:'';
  let out=[
    {name:'Breakfast', time:'08:00', notes:p.breakfast||'Oatmeal', date:date},
    {name:'Lunch', time:'12:00', notes:p.lunch||'Turkey sandwich', date:date},
    {name:'Dinner', time:'18:00', notes:p.dinner||'Rice/chicken', date:date},
    {name:'Snacks', time:'15:30', notes:p.snacks||'Fruit/yogurt', date:date}
  ];
  let sugDiv=document.getElementById('suggestion-list');
  sugDiv.innerHTML="";
  out.forEach(function(m){
    let d=document.createElement('div');
    d.className="suggestion-item";
    d.innerHTML=`<b>${m.name}</b> <span>(${m.time} on ${m.date})</span><br><i>${m.notes}${restxt}</i>
    <br><button class='add-to-plan-btn' data-meal='${m.name}' data-time='${m.time}' data-notes="${encodeURIComponent(m.notes)}">Add to Plan</button>`;
    sugDiv.appendChild(d);
  });
  setTimeout(function(){
    document.querySelectorAll('.add-to-plan-btn').forEach(btn=>{
      btn.onclick=function(){
        let meal={name:this.getAttribute('data-meal'), time:this.getAttribute('data-time'), notes:decodeURIComponent(this.getAttribute('data-notes'))+(restxt?" "+restxt:"")};
        // Add meal for current date to the planned meal list
        let meals=JSON.parse(localStorage.getItem('plannedMeals')||'[]');
        meals.push(meal); localStorage.setItem('plannedMeals',JSON.stringify(meals));
        alert("Meal added for " + meal.time);
      }
    });
  },50);
};
</script>
