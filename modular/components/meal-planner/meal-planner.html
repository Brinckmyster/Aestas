<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner - Academic Allies</title>
</head>
<body>
<div id="shared-header-container"></div>
<script>
function getPlannedMeals(){ try{return JSON.parse(localStorage.getItem('plannedMeals')||'[]');}catch(e){return[];} }
function setPlannedMeals(a){ localStorage.setItem('plannedMeals', JSON.stringify(a||[])); }
function renderPlannedMeals(){
  const el=document.getElementById('planned-meals'); if(!el) return;
  const meals=getPlannedMeals(); el.innerHTML='';
  if(!meals.length){ el.innerHTML='<div>No meals planned yet.</div>'; return; }
  meals.forEach((m,i)=>{
    const row=document.createElement('div'); row.style.margin='0.25em 0';
    row.innerHTML=(m.time?(m.time+' · '):'')+'<b>'+m.kind+':</b> '+m.text+' ';
    const btn=document.createElement('button'); btn.textContent='Remove'; btn.onclick=()=>{ removePlannedMeal(i); };
    row.appendChild(btn); el.appendChild(row);
  });
}
function addPlannedMeal(kind,time,text){ const a=getPlannedMeals(); a.push({kind,time:time||'',text}); setPlannedMeals(a); renderPlannedMeals(); }
function removePlannedMeal(i){ const a=getPlannedMeals(); if(i>=0&&i<a.length){ a.splice(i,1); setPlannedMeals(a); renderPlannedMeals(); } }
function resetPlannedMeals(){ setPlannedMeals([]); renderPlannedMeals(); }
document.addEventListener('DOMContentLoaded', ()=>{
  if(!document.getElementById('planned-meals')){
    const tgt=document.querySelector('main')||document.body; const sec=document.createElement('section');
    sec.innerHTML='<h3>Your Plan</h3><div id="planned-meals"></div><button id="reset-plan">Reset Plan</button>'; tgt.appendChild(sec);
  }
  const r=document.getElementById('reset-plan'); if(r){ r.onclick=resetPlannedMeals; }
  renderPlannedMeals();
});

// Auto-load shared header from modular repo
fetch('../../shared-header.html')
    .then(response => response.text())
    .then(html => {
        document.getElementById('shared-header-container').innerHTML = html;
    })
    .catch(error => console.log('Header not found, continuing without navigation'));
</script>

<!-- Load pdf.js from CDN for PDF parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>

<section id="meal-planner" class="meal-planner" aria-label="Meal Planner and Suggestion Tool">
    <h2>Meal Planner</h2>
    <div class="meal-upload">
        <label for="base-meal-file" class="upload-label">Upload Base Meal Plan:</label>
        <input type="file" id="base-meal-file" accept=".json,.txt,.csv,.pdf" aria-label="Upload base meal plan" />
        <button type="button" id="load-base-meal" class="upload-btn">Load Base Plan</button>
    </div>
    <p class="file-types">File types accepted: .json, .txt, .csv, .pdf</p>
    <div class="meal-summary" aria-live="polite">
        <span id="meals-today">Meals Planned Today: <strong>0</strong></span>
        <button type="button" id="reset-meals" class="reset-btn" aria-label="Reset daily meals">Reset</button>
        <button type="button" id="suggest-meals" class="suggest-btn" aria-label="Generate meal suggestions">Suggest Meals</button>
    </div>
    <form id="add-meal-form" class="add-meal-form" autocomplete="off">
        <label for="meal-name">Meal</label>
        <input type="text" id="meal-name" name="meal-name" required aria-required="true" maxlength="40" />
        <label for="meal-time">Time</label>
        <input type="time" id="meal-time" name="meal-time" required aria-required="true" />
        <label for="meal-notes">Notes</label>
        <input type="text" id="meal-notes" name="meal-notes" maxlength="80" />
        <button type="submit" class="add-btn">Add Meal</button>
    </form>
    <div id="suggestion-list" class="suggestion-list" aria-label="Meal Suggestions"></div>
    <ul id="meal-list" class="meal-list" aria-label="Planned Meals"></ul>
</section>

<style>
.meal-planner {
    background: #f8fafc;
    border-radius: 1rem;
    padding: 1.5rem;
    max-width: 600px;
    margin: 2rem auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
}
.meal-planner h2 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
    color: #22223b;
}
.meal-upload {
    display: flex;
    align-items: center;
    gap: 1em;
    margin-bottom: 0.5em;
}
.upload-label { font-weight: 600; }
.upload-btn {
    background: #3b82f6;
    color: #fff;
    border: none;
    border-radius: 0.5em;
    padding: 0.4em 1.2em;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
}
.upload-btn:hover { background: #2563eb; }
.file-types {
    font-size: 0.9em;
    color: #555;
    margin-bottom: 1em;
}
.meal-summary {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    font-size: 1.1em;
    gap: 1em;
}
.reset-btn {
    background: #ef4444;
    color: #fff;
    border: none;
    border-radius: 0.5em;
    padding: 0.4em 1em;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
}
.reset-btn:hover { background: #dc2626; }
.suggest-btn {
    background: #22c55e;
    color: #fff;
    border: none;
    border-radius: 0.5em;
    padding: 0.4em 1em;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
}
.suggest-btn:hover { background: #16a34a; }
.add-meal-form {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5em 1em;
    align-items: flex-end;
    margin-bottom: 1rem;
}
.add-meal-form label {
    flex: 1 1 100px;
    font-weight: 600;
}
.add-meal-form input {
    flex: 2 1 120px;
    padding: 0.3em;
    border-radius: 0.3em;
    border: 1px solid #bdbdbd;
}
.add-btn {
    background: #22c55e;
    color: #fff;
    border: none;
    border-radius: 0.5em;
    padding: 0.5em 1.2em;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
}
.add-btn:hover { background: #16a34a; }
.meal-list, .suggestion-list {
    list-style: none;
    padding: 0;
    margin: 0;
}
.meal-item, .suggestion-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #fff;
    border-radius: 0.5em;
    padding: 0.7em 1em;
    margin-bottom: 0.5em;
    box-shadow: 0 1px 3px rgba(0,0,0,0.03);
}
.meal-info, .suggestion-info {
    display: flex;
    flex-direction: column;
}
.meal-name, .suggestion-name {
    font-weight: 600;
    color: #22223b;
}
.meal-time, .suggestion-time {
    color: #3b82f6;
    font-size: 0.95em;
}
.meal-notes, .suggestion-notes {
    color: #555;
    font-size: 0.95em;
}
.remove-btn, .add-suggestion-btn {
    background: #bdbdbd;
    color: #22223b;
    border: none;
    border-radius: 0.5em;
    padding: 0.3em 0.9em;
    font-size: 1em;
    cursor: pointer;
    transition: background 0.2s;
}
.remove-btn:hover, .add-suggestion-btn:hover { background: #a3a3a3; }
.remove-btn:focus, .add-suggestion-btn:focus { outline: 2px solid #ef4444; }
@media (max-width: 700px) {
    .meal-planner { padding: 1em; }
    .add-meal-form {
        flex-direction: column;
        gap: 0.5em 0;
    }
    .meal-summary {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5em;
    }
}
</style>

<script>
// CAj: Fixed meal planner logic for Mary's format and universal meal plans
let meals = [];
let baseMeals = [];
let dietaryRules = {
    diagnoses: [],
    carbohydrates: [],
    proteins: [],
    fruitsVeggies: [],
    fats: [],
    restricted: [],
    mealTimes: [],
    timingRules: [],
    prep: []
};

function updateMealsDisplay() {
    const mealsElem = document.getElementById('meals-today');
    mealsElem.innerHTML = `Meals Planned Today: <strong>${meals.length}</strong>`;
}

function renderMeals() {
    const list = document.getElementById('meal-list');
    list.innerHTML = '';
    meals.forEach((meal, idx) => {
        const li = document.createElement('li');
        li.className = 'meal-item';
        li.setAttribute('data-idx', idx);
        
        const info = document.createElement('div');
        info.className = 'meal-info';
        
        const name = document.createElement('span');
        name.className = 'meal-name';
        name.textContent = meal.name;
        info.appendChild(name);
        
        const time = document.createElement('span');
        time.className = 'meal-time';
        time.textContent = `Time: ${meal.time}`;
        info.appendChild(time);
        
        if (meal.notes) {
            const notes = document.createElement('span');
            notes.className = 'meal-notes';
            notes.textContent = `Notes: ${meal.notes}`;
            info.appendChild(notes);
        }
        
        li.appendChild(info);
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.type = 'button';
        removeBtn.setAttribute('aria-label', `Remove meal ${meal.name}`);
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => {
            meals.splice(idx, 1);
            saveMeals();
            renderMeals();
            updateMealsDisplay();
        });
        
        li.appendChild(removeBtn);
        list.appendChild(li);
    });
}

function renderSuggestions(suggestions) {
    const list = document.getElementById('suggestion-list');
    list.innerHTML = '';
    suggestions.forEach(meal => {
        const div = document.createElement('div');
        div.className = 'suggestion-item';
        
        const info = document.createElement('div');
        info.className = 'suggestion-info';
        
        const name = document.createElement('span');
        name.className = 'suggestion-name';
        name.textContent = meal.name;
        info.appendChild(name);
        
        const time = document.createElement('span');
        time.className = 'suggestion-time';
        time.textContent = `Time: ${meal.time}`;
        info.appendChild(time);
        
        if (meal.notes) {
            const notes = document.createElement('span');
            notes.className = 'suggestion-notes';
            notes.textContent = `Notes: ${meal.notes}`;
            info.appendChild(notes);
        }
        
        div.appendChild(info);
        
        const addBtn = document.createElement('button');
        addBtn.className = 'add-suggestion-btn';
        addBtn.type = 'button';
        addBtn.setAttribute('aria-label', `Add suggested meal ${meal.name} to plan`);
        addBtn.textContent = 'Add to Plan';
        addBtn.addEventListener('click', () => {
            meals.push({ ...meal });
            saveMeals();
            renderMeals();
            updateMealsDisplay();
        });
        
        div.appendChild(addBtn);
        list.appendChild(div);
    });
}

// [CAj-AUTO] Original generateSuggestions commented out.
// [CAj-AUTO] Original generateSuggestions commented out.
////

function generateSuggestions(){
  try{
    let plan=null; try{ plan=JSON.parse(localStorage.getItem('simpleMealPlan')||'null'); }catch(e){}
    const hasGastro=(plan&&plan.restrictions||'').toLowerCase().includes('gastro');
    const soft=hasGastro?['Broth with soft noodles','Smooth yogurt with honey','Mashed potatoes (smooth)','Scrambled eggs (soft)','Thin cream of wheat']:[];
    const cat={Breakfast:['Oatmeal with fruit','Scrambled eggs and toast','Greek yogurt with granola',...soft],Lunch:['Turkey & cheese sandwich','Chicken salad wrap','Soup and crackers',...soft],Dinner:['Chicken stir fry','Rice and beans','Pasta with marinara',...soft],Snack:['Apple slices','Yogurt','Broth','Banana','Cheese and crackers',...soft]};
    const slots=[]; if(plan&&Array.isArray(plan.meals)){ for(const m of plan.meals) slots.push({kind:m.name,time:m.time||'',want:m.text||''}); } else { slots.push({kind:'Breakfast',time:'08:00'},{kind:'Lunch',time:'12:00'},{kind:'Dinner',time:'18:00'}); }
    const snackTimes=(plan&&plan.snacks&&Array.isArray(plan.snacks.times))?plan.snacks.times:[]; for(const t of snackTimes) slots.push({kind:'Snack',time:t, want:(plan&&plan.snacks&&plan.snacks.text)||''});
    const sugg=slots.map(s=>{ const u=[...new Set(cat[s.kind]||cat.Snack)]; return {kind:s.kind,time:s.time,options:u.slice(0,3)}; });
    const list=document.getElementById('suggestions-list'); if(list){ list.innerHTML=''; sugg.forEach(s=>{ const w=document.createElement('div'); w.style.margin='0.5em 0'; const t=document.createElement('div'); t.innerHTML='<b>'+ (s.time?(s.time+' · '):'') + s.kind + '</b>'; w.appendChild(t); const o=document.createElement('div'); s.options.forEach(opt=>{ const b=document.createElement('button'); b.textContent='Add: '+opt; b.style.marginRight='0.5em'; b.onclick=()=>addPlannedMeal(s.kind,s.time,opt); o.appendChild(b); }); w.appendChild(o); list.appendChild(w); }); }
  }catch(e){ const list=document.getElementById('suggestions-list'); if(list){ list.innerHTML='<div>Suggestions unavailable. Using fallback.</div>'; } }
}
catch(e){}
    const hasGastro=(plan&&plan.restrictions||'').toLowerCase().includes('gastro');
    const soft=hasGastro?['Broth with soft noodles','Smooth yogurt with honey','Mashed potatoes (smooth)','Scrambled eggs (soft)','Thin cream of wheat']:[];
    const cat={Breakfast:['Oatmeal with fruit','Scrambled eggs and toast','Greek yogurt with granola',...soft],
               Lunch:['Turkey & cheese sandwich','Chicken salad wrap','Soup and crackers',...soft],
               Dinner:['Chicken stir fry','Rice and beans','Pasta with marinara',...soft],
               Snack:['Apple slices','Yogurt','Broth','Banana','Cheese and crackers',...soft]};
    const slots=[];
    if(plan&&Array.isArray(plan.meals)){ for(const m of plan.meals) slots.push({kind:m.name,time:m.time||'',want:m.text||''}); }
    else { slots.push({kind:'Breakfast',time:'08:00'},{kind:'Lunch',time:'12:00'},{kind:'Dinner',time:'18:00'}); }
    const snackTimes=(plan&&plan.snacks&&Array.isArray(plan.snacks.times))?plan.snacks.times:[];
    for(const t of snackTimes) slots.push({kind:'Snack',time:t, want:(plan&&plan.snacks&&plan.snacks.text)||''});

    const sugg=slots.map(s=>{ const u=[...new Set(cat[s.kind]||cat.Snack)]; return {kind:s.kind,time:s.time,options:u.slice(0,3)}; });

    const list=document.getElementById('suggestions-list');
    if(list){
      list.innerHTML='';
      sugg.forEach(s=>{
        const wrap=document.createElement('div'); wrap.style.margin='0.5em 0';
        const title=document.createElement('div'); title.innerHTML='<b>'+ (s.time?(s.time+' · '):'') + s.kind + '</b>';
        wrap.appendChild(title);
        const opts=document.createElement('div');
        s.options.forEach(opt=>{
          const b=document.createElement('button'); b.textContent='Add: '+opt; b.style.marginRight='0.5em';
          b.onclick=()=>addPlannedMeal(s.kind,s.time,opt);
          opts.appendChild(b);
        });
        wrap.appendChild(opts);
        list.appendChild(wrap);
      });
    }
  }catch(e){
    const list=document.getElementById('suggestions-list'); if(list){ list.innerHTML='<div>Suggestions unavailable. Using fallback.</div>'; }
  }
}

////    
////    const suggestions = [];
////    const shuffledTimes = [...dietaryRules.mealTimes].sort(() => Math.random() - 0.5).slice(0, Math.min(3, dietaryRules.mealTimes.length));
////    
////    shuffledTimes.forEach(time => {
////        const currentTime = time.replace(/[^\d:]/g, '');
////        const currentHour = parseInt(currentTime.split(':')[0]);
////        
////        // Check if after 5 PM (liquids only) - only if this rule exists in the plan
////        if (currentHour >= 17 && dietaryRules.timingRules.some(rule => rule.rule && rule.rule.includes('liquid'))) {
////            suggestions.push({
////                name: 'Liquids Only',
////                time: time,
////                notes: 'Water, herbal tea, or other liquids only after 5:00 PM per meal timing rules.'
////            });
////            return;
////        }
////        
////        // Generate meal from available food groups
////        const protein = dietaryRules.proteins[Math.floor(Math.random() * dietaryRules.proteins.length)] || 'protein';
////        const carb = dietaryRules.carbohydrates[Math.floor(Math.random() * dietaryRules.carbohydrates.length)] || 'carbohydrate';
////        const fruitVeg = dietaryRules.fruitsVeggies[Math.floor(Math.random() * dietaryRules.fruitsVeggies.length)] || 'vegetable';
////        const fat = dietaryRules.fats[Math.floor(Math.random() * dietaryRules.fats.length)] || 'healthy fat';
////        
////        const name = `${protein.split('(')[0].trim()} with ${carb.split('(')[0].trim()}`;
////        let notes = `Include: ${fruitVeg.split('(')[0].trim()} prepared with ${fat.split('(')[0].trim()}. `;
////        
////        // Add restrictions
////        if (dietaryRules.restricted.length > 0) {
////            notes += `Avoid: ${dietaryRules.restricted.join(', ')}. `;
////        }
////        
////        // Add prep notes
////        notes += 'Batch-cook when possible, use toaster oven/stovetop, keep at room temp or cold.';
////        
////        suggestions.push({ name, time, notes: notes.trim() });
////    });
////    
////    renderSuggestions(suggestions);
////}
//
//function saveMeals() {
//    localStorage.setItem('plannedMeals', JSON.stringify(meals));
//}

function loadMeals() {
    const saved = localStorage.getItem('plannedMeals');
    if (saved) {
        try {
            meals = JSON.parse(saved);
        } catch {
            meals = [];
        }
    }
}

function saveBaseMeals() {
    localStorage.setItem('baseMeals', JSON.stringify(baseMeals));
    localStorage.setItem('dietaryRules', JSON.stringify(dietaryRules));
}

function loadBaseMeals() {
    const savedMeals = localStorage.getItem('baseMeals');
    const savedRules = localStorage.getItem('dietaryRules');
    
    if (savedMeals) {
        try {
            baseMeals = JSON.parse(savedMeals);
        } catch {
            baseMeals = [];
        }
    }
    
    if (savedRules) {
        try {
            dietaryRules = JSON.parse(savedRules);
        } catch {
            dietaryRules = {
                diagnoses: [], carbohydrates: [], proteins: [], fruitsVeggies: [], 
                fats: [], restricted: [], mealTimes: [], timingRules: [], prep: []
            };
        }
    }
}

function resetMeals() {
    meals = [];
    saveMeals();
    renderMeals();
    updateMealsDisplay();
}

async function parseBaseMealFile(file, callback) {
    const extension = file.name.split('.').pop().toLowerCase();
    let textContent = '';
    
    try {
        if (extension === 'pdf') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
            
            const reader = new FileReader();
            reader.onload = async function (e) {
                const typedArray = new Uint8Array(e.target.result);
                const pdf = await pdfjsLib.getDocument(typedArray).promise;
                let text = '';
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    text += content.items.map(item => item.str).join(' ') + '\n';
                }
                textContent = text;
            };
            reader.readAsArrayBuffer(file);
            await new Promise(resolve => { reader.onloadend = resolve; });
        } else {
            const reader = new FileReader();
            reader.onload = function (e) { textContent = e.target.result; };
            reader.readAsText(file);
            await new Promise(resolve => { reader.onloadend = resolve; });
        }
        
        let parsedMeals = [];
        dietaryRules = {
            diagnoses: [], carbohydrates: [], proteins: [], fruitsVeggies: [], 
            fats: [], restricted: [], mealTimes: [], timingRules: [], prep: []
        };
        
        const lines = textContent.split('\n').filter(Boolean);
        let currentSection = '';
        
        lines.forEach(line => {
            // Section headers (exact match to Mary's format)
            if (line.match(/Diagnoses?\s*&?\s*Needs?/i)) { currentSection = 'diagnoses'; return; }
            if (line.match(/Food\s*Restrictions?/i)) { currentSection = 'restricted'; return; }
            if (line.match(/Carbohydrates?/i)) { currentSection = 'carbohydrates'; return; }
            if (line.match(/Proteins?/i)) { currentSection = 'proteins'; return; }
            if (line.match(/Fruits?\s*&?\s*Vegetables?/i)) { currentSection = 'fruitsVeggies'; return; }
            if (line.match(/Fats?/i)) { currentSection = 'fats'; return; }
            if (line.match(/Meal\s*Timing\s*&?\s*Appliances?/i)) { currentSection = 'timing'; return; }
            if (line.match(/Corn-Derived/i)) { currentSection = 'corn'; return; }
            
            // Parse content based on current section
            if (currentSection && line.trim()) {
                if (currentSection === 'timing') {
                    // Extract meal times (Solids: 10:30 am, 1:30 pm, 4:30 pm)
                    const timeMatch = line.match(/Solids?:\s*([^;]+)/i);
                    if (timeMatch) {
                        const times = timeMatch[1].split(',').map(t => {
                            let time = t.trim();
                            // Convert to 24-hour format
                            if (time.match(/pm/i) && !time.match(/12:/)) {
                                const hours = parseInt(time.split(':')[0]);
                                time = time.replace(/\d{1,2}:/, `${hours + 12}:`);
                            }
                            return time.replace(/\s*(am|pm)/gi, '');
                        }).filter(t => t.match(/\d{1,2}:\d{2}/));
                        dietaryRules.mealTimes.push(...times);
                    }
                    
                    // Extract timing rules
                    if (line.match(/liquids.*only.*after.*5.*pm/i)) {
                        dietaryRules.timingRules.push({ type: 'liquids', rule: 'only after 5 PM' });
                    }
                    
                    // Extract prep instructions
                    if (line.match(/prep|batch|toaster|stovetop/i)) {
                        dietaryRules.prep.push(line.trim());
                    }
                } else if (currentSection === 'restricted') {
                    // Parse restrictions
                    const items = line.split(/[,;]/).map(item => item.trim()).filter(Boolean);
                    items.forEach(item => {
                        // Extract "No X" patterns
                        const noMatch = item.match(/No\s+([^(]+)/i);
                        if (noMatch) {
                            dietaryRules.restricted.push(noMatch[1].trim());
                        } else if (!item.match(/^\*/)) {
                            dietaryRules.restricted.push(item);
                        }
                    });
                } else {
                    // Parse food categories
                    const items = line.split(/[•,;]/).map(item => item.trim()).filter(item => item.length > 2 && !item.match(/^\*/));
                    if (items.length > 0) {
                        dietaryRules[currentSection].push(...items);
                    }
                }
            }
        });
        
        // Generate base meals for each meal time
        dietaryRules.mealTimes.forEach(time => {
            parsedMeals.push({ 
                name: `Meal suggestion for ${time}`, 
                time: time,
                notes: 'Generated from base meal plan'
            });
        });
        
        if (parsedMeals.length === 0 && Object.values(dietaryRules).flat().length === 0) { parsedMeals = [{name:'Breakfast', time:'08:00', notes:'Default meal'}]; dietaryRules = {}; }
        
        callback(parsedMeals);
        
    } catch (err) {
        alert(`Error parsing file: ${err.message}. Please ensure the file contains valid meal data or dietary rules.`);
    }
}

document.addEventListener('DOMContentLoaded', function () {
    loadMeals();
    loadBaseMeals();
    renderMeals();
    updateMealsDisplay();
    
    document.getElementById('add-meal-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const name = document.getElementById('meal-name').value.trim();
        const time = document.getElementById('meal-time').value;
        const notes = document.getElementById('meal-notes').value.trim();
        
        if (!name || !time) return;
        
        meals.push({ name, time, notes });
        saveMeals();
        renderMeals();
        updateMealsDisplay();
        this.reset();
    });
    
    document.getElementById('reset-meals').addEventListener('click', function () {
        if (confirm('Reset all planned meals for today?')) {
            resetMeals();
        }
    });
    
    document.getElementById('load-base-meal').addEventListener('click', function () {
        const fileInput = document.getElementById('base-meal-file');
        const file = fileInput.files[0];
        
        if (!file) {
            alert('Please select a base meal plan file to upload.');
            return;
        }
        
        parseBaseMealFile(file, function (parsedMeals) {
            baseMeals = parsedMeals;
            saveBaseMeals();
            alert(`Base meal plan loaded with ${baseMeals.length} meal times and dietary rules! Click "Suggest Meals" to get suggestions.`);
            renderSuggestions([]);
        });
    });
    
    document.getElementById('suggest-meals').addEventListener('click', function () {
        generateSuggestions();
    });
});
</script>

<script src="universal-suggestor.js"></script>








<!-- BEGIN CAj ONE-MODAL PATCH -->
<button id="show-plan-template" style="margin-bottom:1em;">Show/Edit Base Plan Template</button>
<div id="plan-template-modal" style="display:none;position:fixed;top:10vh;left:50%;transform:translateX(-50%);z-index:1002;background:#fff;padding:1.5rem 2rem;border-radius:1em;box-shadow:0 0 16px #222;max-width:420px;width:90%">
  <h3>Meal Plan Template</h3>
  <form id="template-form">
    <label>Date: <input type="date" name="plandate" id="plandate"></label><br>
    <label>Breakfast (time): <input type="time" name="breakfast_time" value="08:00"> <input type="text" name="breakfast" maxlength="60" placeholder="Oatmeal + fruit"></label><br>
    <label>Lunch (time): <input type="time" name="lunch_time" value="12:00"> <input type="text" name="lunch" maxlength="60" placeholder="Turkey & cheese"></label><br>
    <label>Dinner (time): <input type="time" name="dinner_time" value="18:00"> <input type="text" name="dinner" maxlength="60" placeholder="Chicken stir fry"></label><br>
    <label>Snacks (times): <input type="text" name="snack_times" placeholder="10:30, 15:00, 20:30"></label><br>
    <label>Snacks (text): <input type="text" name="snacks" maxlength="80" placeholder="Yogurt; apple slices; broth"></label><br>
    <br><b>Dietary Restrictions/Needs:</b><br>
    <textarea name="restrictions" rows="3" placeholder="gluten free, gastroparesis, diabetes, kosher, allergies" style="width:98%"></textarea>
    <br>
    <button type="submit">Save Plan</button>
    <button type="button" id="close-template-modal">Cancel</button>
  </form>
</div>
<script>(function(){const b=document.getElementById('show-plan-template');if(b){b.onclick=()=>{document.getElementById('plan-template-modal').style.display='block';}}const c=document.getElementById('close-template-modal');if(c){c.onclick=()=>{document.getElementById('plan-template-modal').style.display='none';}}const f=document.getElementById('template-form');if(f){f.onsubmit=function(e){e.preventDefault();const snackTimes=(this.snack_times.value||'').split(',').map(s=>s.trim()).filter(Boolean);const plan={date:this.plandate.value||null,meals:[{name:'Breakfast',time:this.breakfast_time.value||'08:00',text:this.breakfast.value||'Oatmeal with fruit'},{name:'Lunch',time:this.lunch_time.value||'12:00',text:this.lunch.value||'Turkey & cheese sandwich'},{name:'Dinner',time:this.dinner_time.value||'18:00',text:this.dinner.value||'Chicken stir fry'}],snacks:{times:snackTimes,text:this.snacks.value||'Yogurt; apple slices; broth'},restrictions:this.restrictions.value||''};localStorage.setItem('simpleMealPlan',JSON.stringify(plan));alert("Plan saved! Click 'Suggest Meals' to apply it.");document.getElementById('plan-template-modal').style.display='none';};}})();</script>
<!-- END CAj ONE-MODAL PATCH -->
<!-- CAJ-ANCHOR:MODALS -->
<script>
(function(){
  // Safe categories fallback so universal-suggestor never throws
  if(!window.cat){ window.cat={
    Breakfast:["Oatmeal with fruit","Scrambled eggs and toast","Yogurt"],
    Lunch:["Turkey & cheese sandwich","Chicken salad wrap","Soup and crackers"],
    Dinner:["Chicken stir fry","Rice and beans","Pasta with marinara"],
    Snack:["Apple slices","Yogurt","Broth"]
  }; }
  function safeSuggest(){ try{ if(typeof generateSuggestions==="function"){ generateSuggestions(); } }catch(e){} }
  if(document.readyState!=="loading") safeSuggest();
  document.addEventListener("DOMContentLoaded", safeSuggest);
  document.addEventListener("DOMContentLoaded", function(){
    var b=document.getElementById("suggest-meals"); if(b){ b.onclick=safeSuggest; }
  });
})();
</script>
</body>
<script>
(function(){
  if(!window.cat){
    };
  }
  function safeSuggest(){
    try { if (typeof generateSuggestions === "function") { generateSuggestions(); } } catch(e) {}
  }
  if (document.readyState !== "loading") safeSuggest();
  
  
    var b = document.getElementById("suggest-meals");
    if (b) b.onclick = safeSuggest;
  });
})();
</script>
</body>
</html>
<style>
  .suggest-btn, .reset-btn, .upload-btn, #add-meal-form button {
    box-shadow: 0 1px 2px rgba(0,0,0,.18);
  }
  .suggest-btn:hover, .reset-btn:hover, .upload-btn:hover { opacity: .9; }
</style>
<script>
(function(){
  function safeSuggest(){
    try {
      if (typeof generateSuggestions === 'function') {
        generateSuggestions();
      } else {
        console.warn('[AA] generateSuggestions not found');
      }
    } catch(e){ console.error('[AA] Suggest error', e); }
  }
  function wireOnce(){
    const s = document.getElementById('suggest-meals');
    if (s && !s.dataset.caj){ s.dataset.caj='1'; s.addEventListener('click', ()=>{ flash(s); safeSuggest(); }); }
    const r = document.getElementById('reset-meals');
    if (r && !r.dataset.caj){ r.dataset.caj='1'; r.addEventListener('click', ()=>{ flash(r); console.log('[AA] Reset clicked'); }); }
    const sugRoot = document.getElementById('suggestions-list') || document;
    if (!sugRoot.dataset.caj){ 
      sugRoot.dataset.caj='1';
      sugRoot.addEventListener('click', (e)=>{
        const b = e.target.closest('button'); if(!b) return;
        if (/^(Add|ADD)/.test((b.textContent||'').trim())) { flash(b); console.log('[AA] Add clicked:', (b.textContent||'').trim()); }
      });
    }
  }
  // Run once now and once on DOM ready
  if (document.readyState !== 'loading'){ wireOnce(); safeSuggest(); }
  document.addEventListener('DOMContentLoaded', ()=>{ wireOnce(); safeSuggest(); });
})();
</script>
<script>
(function(){
  // Fallbacks to prevent reference errors in suggestor
  window.cat = window.cat || {
    Breakfast: ["Oatmeal with fruit","Scrambled eggs and toast","Yogurt with honey"],
    Lunch:     ["Turkey & cheese sandwich","Chicken salad wrap","Soup and crackers"],
    Dinner:    ["Chicken stir fry","Rice and beans","Pasta with marinara"],
    Snack:     ["Apple slices","Yogurt","Broth"]
  };
  // Minimal base plan so suggestor logic that references it does not crash
  window.basePlan = window.basePlan || {
    date: null,
    meals: [
      { name: "Breakfast", time: "08:00", text: "Oatmeal with fruit" },
      { name: "Lunch",     time: "12:00", text: "Turkey & cheese sandwich" },
      { name: "Dinner",    time: "18:00", text: "Chicken stir fry" }
    ],
    snacks: { times: ["10:00","15:00"], text: "Yogurt; apple slices; broth" },
    restrictions: ""
  };

  function flash(el){ if(!el) return; try{ el.classList.add('btn-clicked'); setTimeout(()=>el.classList.remove('btn-clicked'),120); }catch(_){} }
  function safeSuggest(){
    try {
      if (typeof generateSuggestions === 'function') {
        console.log('[AA] Suggest triggered');
        generateSuggestions();
      } else {
        console.warn('[AA] generateSuggestions not found');
      }
    } catch(e){ console.error('[AA] Suggest error', e); }
  }
  function markOnce(el){
    if (!el) return false;
    try {
      if (!el.dataset) el.dataset = {};
      if (el.dataset.caj) return false;
      el.dataset.caj = '1';
      return true;
    } catch(_) { return true; }
  }
  function wireOnce(){
    const s = document.getElementById('suggest-meals');
    if (markOnce(s)){ s && s.addEventListener('click', ()=>{ flash(s); safeSuggest(); }); }
    const r = document.getElementById('reset-meals');
    if (markOnce(r)){ r && r.addEventListener('click', ()=>{ flash(r); console.log('[AA] Reset clicked'); }); }

    const sugRoot = document.getElementById('suggestions-list') || document;
    if (markOnce(sugRoot)){
      sugRoot.addEventListener('click', (e)=>{
        const b = e.target && e.target.closest ? e.target.closest('button') : null;
        if(!b) return;
        const txt = (b.textContent||'').trim();
        if (/^(Add|ADD)/.test(txt)) { flash(b); console.log('[AA] Add clicked:', txt); }
      });
    }
  }
  if (document.readyState !== 'loading'){ wireOnce(); safeSuggest(); }
  document.addEventListener('DOMContentLoaded', ()=>{ wireOnce(); safeSuggest(); });
})();
</script>
