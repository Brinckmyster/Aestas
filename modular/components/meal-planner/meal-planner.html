<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Planner - Academic Allies</title>
</head>
<body>
  <div id="shared-header-container"></div>
  <script>
  // Auto-load shared header from modular repo
  fetch('../../shared-header.html')
    .then(response => response.text())
    .then(html => { document.getElementById('shared-header-container').innerHTML = html; })
    .catch(error => console.log('Header not found, continuing without navigation'));
  </script>
  <!-- Load pdf.js from CDN for PDF parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <section id="meal-planner" class="meal-planner" aria-label="Meal Planner and Suggestion Tool">
    <h2>Meal Planner</h2>
    <div class="meal-upload">
      <label for="base-meal-file" class="upload-label">Upload Base Plan (optional):</label>
      <input type="file" id="base-meal-file" accept=".json,.txt,.csv,.pdf" aria-label="Upload base plan (optional)" />
      <button type="button" id="load-base-meal" class="upload-btn">Load Plan</button>
    </div>
    <p class="file-types">File types accepted: .json, .txt, .csv, .pdf (or use default - no upload required!)</p>

    <button id="show-plan-template" type="button" class="template-btn">Show Editable Base Plan Template</button>
    <div id="plan-template-modal" style="display:none; background:#fff; border:2px solid #222; padding:1em; max-width:400px; margin:1em auto;">
      <h3>Starter Base Plan Template</h3>
      <form id="template-form">
        <table class="template-table">
          <tr><th>Day</th><th>Breakfast</th><th>Lunch</th><th>Dinner</th></tr>
          <tr>
            <td><input type="text" value="Monday" name="day1" /></td>
            <td><input type="text" value="" name="breakfast1" /></td>
            <td><input type="text" value="" name="lunch1" /></td>
            <td><input type="text" value="" name="dinner1" /></td>
          </tr>
          <tr>
            <td><input type="text" value="Tuesday" name="day2" /></td>
            <td><input type="text" value="" name="breakfast2" /></td>
            <td><input type="text" value="" name="lunch2" /></td>
            <td><input type="text" value="" name="dinner2" /></td>
          </tr>
        </table>
        <p>Nutrition goals (optional):  
          <label>Calories <input type="text" name="calories" /></label>
          <label>Protein <input type="text" name="protein" /></label>
          <label>Carbs <input type="text" name="carbs" /></label>
          <label>Fat <input type="text" name="fat" /></label>
        </p>
        <label>Notes: <br /><textarea name="notes" style="width:98%"></textarea></label><br>
        <button type="submit">Use this plan</button>
        <button type="button" id="close-template-modal">Cancel</button>
      </form>
    </div>

    <div class="meal-summary" aria-live="polite">
      <span id="meals-today">Meals Planned Today: <strong>0</strong></span>
      <button type="button" id="reset-meals" class="reset-btn" aria-label="Reset daily meals">Reset</button>
      <button type="button" id="suggest-meals" class="suggest-btn" aria-label="Generate meal suggestions">Suggest Meals</button>
    </div>

    <form id="add-meal-form" class="add-meal-form" autocomplete="off">
      <label for="meal-name">Meal</label>
      <input type="text" id="meal-name" name="meal-name" required aria-required="true" maxlength="40" />
      <label for="meal-time">Time</label>
      <input type="time" id="meal-time" name="meal-time" required aria-required="true" />
      <label for="meal-notes">Notes</label>
      <input type="text" id="meal-notes" name="meal-notes" maxlength="80" />
      <button type="submit" class="add-btn">Add Meal</button>
    </form>

    <div id="suggestion-list" class="suggestion-list" aria-label="Meal Suggestions"></div>
    <ul id="meal-list" class="meal-list" aria-label="Planned Meals"></ul>
  </section>

  <style>
    .meal-planner { background: #f8fafc; border-radius: 1rem; padding: 1.5rem; max-width: 600px; margin: 2rem auto; box-shadow: 0 2px 8px rgba(0,0,0,0.07);}
    .meal-planner h2 { font-size: 1.5rem; margin-bottom: 1rem; color: #22223b;}
    .meal-upload { display: flex; align-items: center; gap: 1em; margin-bottom: 0.5em;}
    .upload-label { font-weight: 600; }
    .upload-btn, .reset-btn, .suggest-btn, .template-btn { background: #3b82f6; color: #fff; border: none; border-radius: 0.5em; padding: 0.4em 1.2em; font-size: 1em; cursor: pointer; transition: background 0.2s;}
    .reset-btn { background: #ef4444; margin-left: 1em;}
    .reset-btn:hover { background: #dc2626;}
    .suggest-btn { background: #22c55e;}
    .suggest-btn:hover { background: #16a34a;}
    .file-types { font-size: 0.9em; color: #555; margin-bottom: 1em;}
    .meal-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; font-size: 1.1em; gap: 1em; }
    .add-meal-form { display: flex; flex-wrap: wrap; gap: 0.5em 1em; align-items: flex-end; margin-bottom: 1rem;}
    .add-meal-form label { flex: 1 1 100px; font-weight: 600;}
    .add-meal-form input { flex: 2 1 120px; padding: 0.3em; border-radius: 0.3em; border: 1px solid #bdbdbd;}
    .add-btn { background: #22c55e; color: #fff; border: none; border-radius: 0.5em; padding: 0.5em 1.2em; font-size: 1em; cursor: pointer; transition: background 0.2s;}
    .add-btn:hover { background: #16a34a;}
    .meal-list, .suggestion-list { list-style: none; padding: 0; margin: 0;}
    .meal-item, .suggestion-item { display: flex; align-items: center; justify-content: space-between; background: #fff; border-radius: 0.5em; padding: 0.7em 1em; margin-bottom: 0.5em; box-shadow: 0 1px 3px rgba(0,0,0,0.03);}
    .meal-info, .suggestion-info { display: flex; flex-direction: column;}
    .meal-name, .suggestion-name { font-weight: 600; color: #22223b;}
    .meal-time, .suggestion-time { color: #3b82f6; font-size: 0.95em;}
    .meal-notes, .suggestion-notes { color: #555; font-size: 0.95em;}
    .remove-btn, .add-suggestion-btn { background: #bdbdbd; color: #22223b; border: none; border-radius: 0.5em; padding: 0.3em 0.9em; font-size: 1em; cursor: pointer; transition: background 0.2s;}
    .remove-btn:hover, .add-suggestion-btn:hover { background: #a3a3a3;}
    .remove-btn:focus, .add-suggestion-btn:focus { outline: 2px solid #ef4444;}
    @media (max-width:700px){ .meal-planner {padding:1em;}.add-meal-form{flex-direction:column;gap:0.5em 0;}.meal-summary{flex-direction:column;align-items:flex-start;gap:0.5em;}}
    .template-table input {width:98%;}
  </style>

  <script>
    let meals = [];
    let basePlan = null;

    function updateMealsDisplay() {
      const mealsElem = document.getElementById('meals-today');
      mealsElem.innerHTML = `Meals Planned Today: <strong>${meals.length}</strong>`;
    }
    function renderMeals() {
      const list = document.getElementById('meal-list');
      list.innerHTML = '';
      meals.forEach((meal, idx) => {
        const li = document.createElement('li');
        li.className = 'meal-item'; li.setAttribute('data-idx', idx);
        const info = document.createElement('div');
        info.className = 'meal-info';
        const name = document.createElement('span');
        name.className = 'meal-name'; name.textContent = meal.name;
        info.appendChild(name);
        const time = document.createElement('span');
        time.className = 'meal-time'; time.textContent = `Time: ${meal.time}`;
        info.appendChild(time);
        if (meal.notes) {
          const notes = document.createElement('span');
          notes.className = 'meal-notes'; notes.textContent = `Notes: ${meal.notes}`;
          info.appendChild(notes);
        }
        li.appendChild(info);
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn'; removeBtn.type = 'button';
        removeBtn.setAttribute('aria-label', `Remove meal ${meal.name}`);
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => { meals.splice(idx, 1); saveMeals(); renderMeals(); updateMealsDisplay(); });
        li.appendChild(removeBtn); list.appendChild(li);
      });
    }
    function renderSuggestions(suggestions) {
      const list = document.getElementById('suggestion-list'); list.innerHTML = '';
      suggestions.forEach(meal => {
        const div = document.createElement('div'); div.className = 'suggestion-item';
        const info = document.createElement('div'); info.className = 'suggestion-info';
        const name = document.createElement('span'); name.className = 'suggestion-name'; name.textContent = meal.name;
        info.appendChild(name);
        const time = document.createElement('span'); time.className = 'suggestion-time'; time.textContent = `Time: ${meal.time}`;
        info.appendChild(time);
        if (meal.notes) {const notes = document.createElement('span'); notes.className='suggestion-notes'; notes.textContent=`Notes: ${meal.notes}`; info.appendChild(notes);}
        div.appendChild(info);
        const addBtn = document.createElement('button'); addBtn.className = 'add-suggestion-btn'; addBtn.type = 'button';
        addBtn.setAttribute('aria-label', `Add suggested meal ${meal.name} to plan`);
        addBtn.textContent = 'Add to Plan';
        addBtn.addEventListener('click', () => { meals.push({ ...meal }); saveMeals(); renderMeals(); updateMealsDisplay(); });
        div.appendChild(addBtn); list.appendChild(div);
      });
    }

    function saveMeals() { localStorage.setItem('plannedMeals', JSON.stringify(meals)); }
    function loadMeals() {
      const saved = localStorage.getItem('plannedMeals');
      if (saved) { try { meals = JSON.parse(saved); } catch { meals = []; } }
    }
    function resetMeals() { meals = []; saveMeals(); renderMeals(); updateMealsDisplay(); }

    // Basic suggestion/flexible meal times (ignores base plan if none present)
    function generateSuggestions() {
      // Suggest 3 meals at basic intervals if no base meal times
      const suggestions = [];
      let times = [];
      if (basePlan && basePlan.meals) {
        for (const m of basePlan.meals) {
          times.push(m.breakfast && m.breakfast !== "" ? "08:00" : null);
          times.push(m.lunch && m.lunch !== "" ? "12:00" : null);
          times.push(m.dinner && m.dinner !== "" ? "18:00" : null);
        }
        times = times.filter(Boolean);
      } else {
        times = ["08:00", "12:00", "18:00"];
      }
      times.slice(0, 3).forEach((time, i) => {
        suggestions.push({
          name: basePlan && basePlan.meals && basePlan.meals[i] ?
            (basePlan.meals[i].breakfast || basePlan.meals[i].lunch || basePlan.meals[i].dinner || `Meal ${i + 1}`) :
            `Meal ${i + 1}`,
          time: time,
          notes: basePlan && basePlan.notes ? basePlan.notes : "Suggested meal"
        });
<<<<<<< HEAD
        
        div.appendChild(addBtn);
        list.appendChild(div);
    });
}

// [CAj-AUTO] Original generateSuggestions commented out.
//function generateSuggestions() {
//    if (dietaryRules.mealTimes.length === 0) {
//        alert('Please upload a base meal plan with meal times first.');
//        return;
//    }
//    
//    const suggestions = [];
//    const shuffledTimes = [...dietaryRules.mealTimes].sort(() => Math.random() - 0.5).slice(0, Math.min(3, dietaryRules.mealTimes.length));
//    
//    shuffledTimes.forEach(time => {
//        const currentTime = time.replace(/[^\d:]/g, '');
//        const currentHour = parseInt(currentTime.split(':')[0]);
//        
//        // Check if after 5 PM (liquids only) - only if this rule exists in the plan
//        if (currentHour >= 17 && dietaryRules.timingRules.some(rule => rule.rule && rule.rule.includes('liquid'))) {
//            suggestions.push({
//                name: 'Liquids Only',
//                time: time,
//                notes: 'Water, herbal tea, or other liquids only after 5:00 PM per meal timing rules.'
//            });
//            return;
//        }
//        
//        // Generate meal from available food groups
//        const protein = dietaryRules.proteins[Math.floor(Math.random() * dietaryRules.proteins.length)] || 'protein';
//        const carb = dietaryRules.carbohydrates[Math.floor(Math.random() * dietaryRules.carbohydrates.length)] || 'carbohydrate';
//        const fruitVeg = dietaryRules.fruitsVeggies[Math.floor(Math.random() * dietaryRules.fruitsVeggies.length)] || 'vegetable';
//        const fat = dietaryRules.fats[Math.floor(Math.random() * dietaryRules.fats.length)] || 'healthy fat';
//        
//        const name = `${protein.split('(')[0].trim()} with ${carb.split('(')[0].trim()}`;
//        let notes = `Include: ${fruitVeg.split('(')[0].trim()} prepared with ${fat.split('(')[0].trim()}. `;
//        
//        // Add restrictions
//        if (dietaryRules.restricted.length > 0) {
//            notes += `Avoid: ${dietaryRules.restricted.join(', ')}. `;
//        }
//        
//        // Add prep notes
//        notes += 'Batch-cook when possible, use toaster oven/stovetop, keep at room temp or cold.';
//        
//        suggestions.push({ name, time, notes: notes.trim() });
//    });
//    
//    renderSuggestions(suggestions);
//}
=======
      });
      renderSuggestions(suggestions);
    }
>>>>>>> 51f8265fc045d249605d21ffb88579f65aef9ed7

    // PDF/txt/csv/json import
    async function parseBasePlanFile(file, callback) {
      const extension = file.name.split('.').pop().toLowerCase();
      let textContent = '';
      try {
        if (extension === 'pdf') {
          pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
          const reader = new FileReader();
          reader.onload = async function (e) {
            const typedArray = new Uint8Array(e.target.result);
            const pdf = await pdfjsLib.getDocument(typedArray).promise;
            let text = '';
            for (let i = 1; i <= pdf.numPages; i++) {
              const page = await pdf.getPage(i);
              const content = await page.getTextContent();
              text += content.items.map(item => item.str).join(' ') + '\n';
            }
            callback(previewParseToObj(text));
          };
          reader.readAsArrayBuffer(file);
        } else {
          const reader = new FileReader();
          reader.onload = function (e) { callback(previewParseToObj(e.target.result)); };
          reader.readAsText(file);
        }
      } catch (err) {
        alert(`Error parsing file: ${err.message}. Please ensure the file contains valid meal data.`);
      }
    }
    // Naive parser: finds table/list lines, guesses meal structure.
    function previewParseToObj(textContent) {
      // Attempt to parse lines for day/meal patterns:
      const lines = textContent.split('\n').map(l=>l.trim()).filter(Boolean);
      let days = [], mealsArr = [];
      lines.forEach(l=>{
        if(l.match(/monday|tuesday|wednesday|thursday|friday|saturday|sunday/i)){
          days.push(l.split(' ')[0]);
        }
      });
      let i=0;
      for(const d of days){mealsArr.push({day:d, breakfast:"", lunch:"", dinner:""}); i++;}
      let notes = lines.filter(l => l.length > 30).join(' ').trim();
      return { meals: mealsArr.length>0?mealsArr:null, notes:notes };
    }

    function populateTemplateToBasePlan(form) {
      let meals=[];
      let dayCount = 2; // Template rows
      for(let i=1;i<=dayCount;i++){
        let day = form[`day${i}`].value;
        let breakfast = form[`breakfast${i}`].value;
        let lunch = form[`lunch${i}`].value;
        let dinner = form[`dinner${i}`].value;
        meals.push({day,breakfast,lunch,dinner});
      }
      let nutritionGoals = {};
      ['calories','protein','carbs','fat'].forEach(k=>nutritionGoals[k]=form[k].value);
      let notes = form['notes'].value;
      return { meals, nutritionGoals, notes };
    }

    document.addEventListener('DOMContentLoaded', function () {
      loadMeals(); renderMeals(); updateMealsDisplay();

      document.getElementById('add-meal-form').addEventListener('submit', function (e) {
        e.preventDefault();
        const name = document.getElementById('meal-name').value.trim();
        const time = document.getElementById('meal-time').value;
        const notes = document.getElementById('meal-notes').value.trim();
        if (!name || !time) return;
        meals.push({ name, time, notes });
        saveMeals(); renderMeals(); updateMealsDisplay(); this.reset();
      });
      document.getElementById('reset-meals').addEventListener('click', function () {
        if (confirm('Reset all planned meals for today?')) { resetMeals(); }
      });
      document.getElementById('load-base-meal').addEventListener('click', function () {
        const fileInput = document.getElementById('base-meal-file');
        const file = fileInput.files[0];
        if (!file) { alert('Please select a base plan file (optional).'); return; }
        parseBasePlanFile(file, function (planObj) {
          basePlan = planObj;
          alert('Base plan file imported (editable via template if needed). Click "Suggest Meals" or add directly.');
        });
      });
      document.getElementById('suggest-meals').addEventListener('click', function () { generateSuggestions(); });

<<<<<<< HEAD
<script src="universal-suggestor.js"></script>
=======
      // Plan template modal
      document.getElementById('show-plan-template').addEventListener('click', () => {
        document.getElementById('plan-template-modal').style.display = 'block';
      });
      document.getElementById('close-template-modal').addEventListener('click', () => {
        document.getElementById('plan-template-modal').style.display = 'none';
      });
      document.getElementById('template-form').addEventListener('submit', function(e){
        e.preventDefault();
        basePlan = populateTemplateToBasePlan(this.elements);
        document.getElementById('plan-template-modal').style.display = 'none';
        alert('Base plan saved! Click "Suggest Meals" or add directly.');
      });
    });
  </script>
>>>>>>> 51f8265fc045d249605d21ffb88579f65aef9ed7
</body>
</html>
