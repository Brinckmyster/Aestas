<!-- BEGIN CAj ONE-MODAL PATCH -->
<button id="show-plan-template" style="margin-bottom:1em;">Show/Edit Base Plan Template</button>
<div id="plan-template-modal" style="display:none;position:fixed;top:10vh;left:50%;transform:translateX(-50%);z-index:1002;background:#fff;padding:1.5rem 2rem;border-radius:1em;box-shadow:0 0 16px #222;max-width:400px">
<h3>Meal Plan Template</h3>
<form id="template-form">
<b>Date:</b> <input type="date" name="plandate" id="plandate"/><br>
<label>Breakfast: <input type="text" name="breakfast" maxlength="40"></label><br>
<label>Lunch: <input type="text" name="lunch" maxlength="40"></label><br>
<label>Dinner: <input type="text" name="dinner" maxlength="40"></label><br>
<label>Snacks: <input type="text" name="snacks" maxlength="40"></label><br>
<br><b>Dietary Restrictions/Needs:</b><br>
<textarea name="restrictions" rows="3" placeholder="gluten free, gastroparesis, kosher, diabetes, allergies, other needs" style="width:98%"></textarea>
<br>
<button type="submit">Save Plan</button>
<button type="button" id="close-template-modal">Cancel</button>
</form>
</div>
<script>
document.getElementById('show-plan-template').onclick=function(){
  let m=document.getElementById('plan-template-modal'); m.style.display='block';
  let p=JSON.parse(localStorage.getItem('simpleMealPlan')||'{}');
  Object.assign(document.getElementById('template-form'), p);
}
document.getElementById('close-template-modal').onclick=function(){
  document.getElementById('plan-template-modal').style.display='none';
};
document.getElementById('template-form').onsubmit=function(e){
  e.preventDefault();
  let p={breakfast:this.breakfast.value||"Oatmeal",lunch:this.lunch.value||"Turkey sandwich",dinner:this.dinner.value||"Rice/chicken",snacks:this.snacks.value||"Fruit/yogurt", restrictions:this.restrictions.value||"None", plandate: this.plandate.value||new Date().toISOString().slice(0,10)};
  localStorage.setItem('simpleMealPlan',JSON.stringify(p));
  alert("Plan saved! Click 'Suggest Meals' to use it.");
  document.getElementById('plan-template-modal').style.display='none';
};
document.getElementById('suggest-meals').onclick=function(){
  let p=JSON.parse(localStorage.getItem('simpleMealPlan')||'{}');
  let date=p.plandate||new Date().toISOString().slice(0,10);
  let restxt=(p.restrictions&&p.restrictions!=='None')?`<br><b>Note:</b> ${p.restrictions}`:'';
  let out=[
    {name:'Breakfast', time:'08:00', notes:p.breakfast||'Oatmeal', date:date},
    {name:'Lunch', time:'12:00', notes:p.lunch||'Turkey sandwich', date:date},
    {name:'Dinner', time:'18:00', notes:p.dinner||'Rice/chicken', date:date},
    {name:'Snacks', time:'15:30', notes:p.snacks||'Fruit/yogurt', date:date}
  ];
  let sugDiv=document.getElementById('suggestion-list');
  sugDiv.innerHTML="";
  out.forEach(function(m){
    let d=document.createElement('div');
    d.className="suggestion-item";
    d.innerHTML=`<b>${m.name}</b> <span>(${m.time} on ${m.date})</span><br><i>${m.notes}${restxt}</i>
    <br><button class='add-to-plan-btn' data-meal='${m.name}' data-time='${m.time}' data-notes="${encodeURIComponent(m.notes)}">Add to Plan</button>`;
    sugDiv.appendChild(d);
  });
  setTimeout(function(){
    document.querySelectorAll('.add-to-plan-btn').forEach(btn=>{
      btn.onclick=function(){
        let meal={name:this.getAttribute('data-meal'), time:this.getAttribute('data-time'), notes:decodeURIComponent(this.getAttribute('data-notes'))+(restxt?" "+restxt:"")};
        let meals=JSON.parse(localStorage.getItem('plannedMeals')||'[]');
        meals.push(meal); localStorage.setItem('plannedMeals',JSON.stringify(meals));
        alert("Meal added for " + meal.time);
      }
    });
  },50);
};
</script>
<!-- END CAj ONE-MODAL PATCH -->
